<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Professional AWJ Calculator with AI Analysis, Data Import, and Predictive Models">
    <meta name="theme-color" content="#1F2937">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQVdKIFByb2Zlc3Npb25hbCBDYWxjdWxhdG9yIiwic2hvcnRfbmFtZSI6IkFXSiBDYWxjIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMxMTE4MjciLCJ0aGVtZV9jb2xvciI6IiMxRjI5MzciLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCNGJXeHVjejBpYUhSMGNEb3ZMM2QzZHk1M015NXZjbWN2TWpBd01DOXpkbWNpSUhkcFpIUm9QU0l4TWpnaUlHaGxhV2RvZEQwaU1USTRJajQ4Y21WamRDQjNhV1IwYUQwaU1USTRMQ0JvWldsbmFIUTlJakV5T0NJZ2NuZzlJakUySWlCbWFXeHNQU0lqTXtKRE9ESkdOaUkvUGk4dmMzWm5QZz09Iiwic2l6ZXMiOiIxMjh4MTI4IiwidHlwZSI6ImltYWdlL3N2Zyt4bWwifV19">
    <title>AWJ Pro Calculator - AI-Powered Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; overflow: hidden; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .gradient-text { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .glass { background: rgba(31, 41, 55, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .btn-glow { box-shadow: 0 0 20px rgba(102, 126, 234, 0.5); transition: all 0.3s; }
        .btn-glow:hover { box-shadow: 0 0 30px rgba(102, 126, 234, 0.8); transform: translateY(-2px); }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide { animation: slideIn 0.4s ease-out; }
        .chart-container { position: relative; height: 300px; width: 100%; }
        input[type="range"] { -webkit-appearance: none; height: 6px; border-radius: 5px; background: #4B5563; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: #667eea; cursor: pointer; }
        input[type="range"]::-moz-range-thumb { width: 18px; height: 18px; border-radius: 50%; background: #667eea; cursor: pointer; }
        .code-block { background: #1a1a1a; border-radius: 8px; padding: 12px; font-family: 'Courier New', monospace; font-size: 12px; overflow-x: auto; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">
    
    <div id="app" class="flex flex-col h-screen">
        <!-- Header -->
        <header class="glass p-4 flex justify-between items-center border-b border-gray-700 z-20">
            <div class="flex items-center space-x-3">
                <svg class="w-8 h-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
                <h1 class="text-xl font-bold gradient-text">AWJ Pro Calculator</h1>
                <span class="px-2 py-1 bg-gradient-to-r from-purple-600 to-indigo-600 text-white text-xs rounded-full font-bold">AI</span>
            </div>
            
            <div class="flex items-center space-x-3">
                <select id="userLevel" class="glass rounded-lg px-3 py-1 text-sm">
                    <option value="student">Student</option>
                    <option value="engineer" selected>Engineer</option>
                    <option value="manager">Manager</option>
                </select>
                
                <select id="lang" class="glass rounded-lg px-3 py-1 text-sm">
                    <option value="en">🇬🇧 English</option>
                    <option value="cs">🇨🇿 Čeština</option>
                    <option value="sk">🇸🇰 Slovenčina</option>
                    <option value="de">🇩🇪 Deutsch</option>
                    <option value="fr">🇫🇷 Français</option>
                    <option value="es">🇪🇸 Español</option>
                    <option value="pl">🇵🇱 Polski</option>
                    <option value="ru">🇷🇺 Русский</option>
                </select>
            </div>
        </header>

        <!-- KPI Bar -->
        <div id="kpi-bar" class="glass p-3 grid grid-cols-5 gap-3 border-b border-gray-700">
            <div class="text-center">
                <div class="text-xs text-gray-400 uppercase mb-1" data-i18n="cutTime">Cut Time</div>
                <div id="kpi-time" class="text-lg font-bold text-blue-400">--:--</div>
            </div>
            <div class="text-center">
                <div class="text-xs text-gray-400 uppercase mb-1" data-i18n="costPerPart">Cost/Part</div>
                <div id="kpi-cost" class="text-lg font-bold text-green-400">-- €</div>
            </div>
            <div class="text-center">
                <div class="text-xs text-gray-400 uppercase mb-1" data-i18n="avgRoughness">Avg. Roughness</div>
                <div id="kpi-ra" class="text-lg font-bold text-orange-400">-- µm</div>
            </div>
            <div class="text-center">
                <div class="text-xs text-gray-400 uppercase mb-1" data-i18n="maxTaper">Max. Taper</div>
                <div id="kpi-taper" class="text-lg font-bold text-red-400">--°</div>
            </div>
            <div class="text-center">
                <div class="text-xs text-gray-400 uppercase mb-1" data-i18n="productivity">Productivity</div>
                <div id="kpi-prod" class="text-lg font-bold text-purple-400">-- m/h</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex overflow-hidden">
            <!-- Left Sidebar - Inputs -->
            <aside class="w-80 glass p-4 overflow-y-auto no-scrollbar border-r border-gray-700">
                <h2 class="text-lg font-bold mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
                    </svg>
                    <span data-i18n="inputs">Inputs</span>
                </h2>
                
                <!-- Material & Geometry -->
                <div class="mb-4 glass rounded-lg p-3">
                    <h3 class="font-semibold text-sm mb-3 text-blue-400" data-i18n="materialGeometry">Material & Geometry</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs text-gray-400 mb-1" data-i18n="material">Material</label>
                            <select id="material" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm"></select>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1" data-i18n="thickness">Thickness (mm)</label>
                            <input type="number" id="thickness" value="8" min="0.1" max="300" step="0.1" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1" data-i18n="cutLength">Cut Length (mm)</label>
                            <input type="number" id="cutLength" value="1000" min="1" step="1" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm">
                        </div>
                    </div>
                </div>

                <!-- Machine Parameters -->
                <div class="mb-4 glass rounded-lg p-3">
                    <h3 class="font-semibold text-sm mb-3 text-green-400" data-i18n="machineParams">Machine Parameters</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs text-gray-400 mb-1" data-i18n="pressure">Pressure (MPa)</label>
                            <div class="flex items-center space-x-2">
                                <input type="range" id="pressure" min="150" max="600" value="300" step="10" class="flex-1">
                                <span id="pressure-val" class="w-16 text-center bg-gray-700 rounded-lg px-2 py-1 text-xs font-bold">300</span>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1" data-i18n="abrasiveFlow">Abrasive Flow (g/min)</label>
                            <div class="flex items-center space-x-2">
                                <input type="range" id="abrasiveFlow" min="100" max="800" value="450" step="10" class="flex-1">
                                <span id="flow-val" class="w-16 text-center bg-gray-700 rounded-lg px-2 py-1 text-xs font-bold">450</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Optimization -->
                <div class="mb-4 glass rounded-lg p-3">
                    <h3 class="font-semibold text-sm mb-3 text-purple-400" data-i18n="optimization">Optimization</h3>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1" data-i18n="tradeoff">Time vs. Quality</label>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs" data-i18n="eco">Eco</span>
                            <input type="range" id="optLevel" min="1" max="5" value="3" step="1" class="flex-1">
                            <span class="text-xs" data-i18n="quality">Quality</span>
                        </div>
                    </div>
                </div>

                <!-- Predictive Model -->
                <div class="glass rounded-lg p-3">
                    <h3 class="font-semibold text-sm mb-3 text-yellow-400" data-i18n="predictiveModel">Predictive Model</h3>
                    <select id="model" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm">
                        <option value="physical" data-i18n-opt="modelPhysical">Physical Model</option>
                        <option value="regression" data-i18n-opt="modelRegression">Linear Regression</option>
                        <option value="polynomial" data-i18n-opt="modelPolynomial">Polynomial Regression</option>
                        <option value="ann" data-i18n-opt="modelANN">Neural Network</option>
                        <option value="hybrid" selected data-i18n-opt="modelHybrid">Hybrid AI Model</option>
                    </select>
                </div>
            </aside>

            <!-- Center - Results & Charts -->
            <section class="flex-1 p-4 overflow-y-auto no-scrollbar">
                <div class="space-y-4">
                    <!-- Recommended Parameters -->
                    <div class="glass rounded-lg p-4 animate-slide">
                        <h3 class="text-lg font-bold mb-3 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span data-i18n="recommendedParams">Recommended Parameters</span>
                        </h3>
                        <div class="grid grid-cols-4 gap-4">
                            <div class="text-center">
                                <div class="text-xs text-gray-400 mb-1" data-i18n="speed">Speed</div>
                                <div id="out-speed" class="text-3xl font-bold text-blue-400">--</div>
                                <div class="text-xs text-gray-500">mm/min</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xs text-gray-400 mb-1" data-i18n="pressure">Pressure</div>
                                <div id="out-pressure" class="text-3xl font-bold text-green-400">--</div>
                                <div class="text-xs text-gray-500">MPa</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xs text-gray-400 mb-1" data-i18n="flow">Flow</div>
                                <div id="out-flow" class="text-3xl font-bold text-orange-400">--</div>
                                <div class="text-xs text-gray-500">g/min</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xs text-gray-400 mb-1" data-i18n="kawj">Kawj</div>
                                <div id="out-kawj" class="text-3xl font-bold text-purple-400">--</div>
                                <div class="text-xs text-gray-500">mm</div>
                            </div>
                        </div>
                    </div>

                    <!-- Visualization -->
                    <div class="glass rounded-lg p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-lg font-bold flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                                <span data-i18n="visualization">Visualization</span>
                            </h3>
                            <select id="chartType" class="glass rounded-lg px-3 py-1 text-sm">
                                <option value="roughness" data-i18n-option="chartRa">Roughness</option>
                                <option value="taper" data-i18n-option="chartTaper">Taper</option>
                                <option value="forces" data-i18n-option="chartForces">Forces</option>
                            </select>
                        </div>
                        <div class="chart-container">
                            <canvas id="mainChart"></canvas>
                        </div>
                    </div>

                    <!-- Discrete Results Table -->
                    <div class="glass rounded-lg p-4">
                        <h3 class="text-lg font-bold mb-3" data-i18n="discreteResults">Discrete Results</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-xs">
                                <thead class="bg-gray-800">
                                    <tr>
                                        <th class="px-3 py-2 text-left" data-i18n="depth">Depth (mm)</th>
                                        <th class="px-3 py-2 text-left">Ra (µm)</th>
                                        <th class="px-3 py-2 text-left">Yret (mm)</th>
                                        <th class="px-3 py-2 text-left" data-i18n="taper">Taper (°)</th>
                                        <th class="px-3 py-2 text-left">Fh (N)</th>
                                        <th class="px-3 py-2 text-left">Fv (N)</th>
                                    </tr>
                                </thead>
                                <tbody id="resultsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Right Sidebar - Analysis -->
            <aside class="w-80 glass p-4 overflow-y-auto no-scrollbar border-l border-gray-700">
                <h2 class="text-lg font-bold mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    <span data-i18n="analysis">Analysis</span>
                </h2>

                <!-- Model Equation -->
                <div id="model-equation" class="mb-4 glass rounded-lg p-3 hidden">
                    <h3 class="font-semibold text-sm mb-2 text-yellow-400" data-i18n="modelEquation">Model Equation</h3>
                    <div id="equation-display" class="code-block text-gray-300"></div>
                    <div id="coefficients" class="mt-2 text-xs text-gray-400"></div>
                </div>

                <!-- Data Import -->
                <div class="mb-4 glass rounded-lg p-3">
                    <h3 class="font-semibold text-sm mb-2" data-i18n="dataImport">Import Measured Data</h3>
                    <input type="file" id="csvUpload" accept=".csv" class="w-full text-xs file:mr-2 file:py-1 file:px-3 file:rounded file:border-0 file:text-xs file:bg-blue-600 file:text-white hover:file:bg-blue-700 mb-2">
                    <div id="upload-status" class="text-xs text-gray-400"></div>
                </div>

                <!-- Cost Breakdown -->
                <div class="mb-4 glass rounded-lg p-3">
                    <h3 class="font-semibold text-sm mb-2" data-i18n="costBreakdown">Cost Breakdown</h3>
                    <div class="h-40">
                        <canvas id="costChart"></canvas>
                    </div>
                </div>

                <!-- Expert Analysis -->
                <div class="mb-4 glass rounded-lg p-3">
                    <h3 class="font-semibold text-sm mb-2 flex items-center">
                        <svg class="w-4 h-4 mr-1 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                        </svg>
                        <span data-i18n="expertAnalysis">Expert Analysis</span>
                    </h3>
                    <button id="generate-analysis" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 py-2 rounded-lg text-sm font-semibold mb-2 btn-glow">
                        <span data-i18n="generateAnalysis">Generate Analysis</span>
                    </button>
                    <div id="analysis-output" class="bg-gray-900 rounded-lg p-3 text-xs h-64 overflow-y-auto no-scrollbar"></div>
                </div>

                <!-- Actions -->
                <div class="space-y-2">
                    <button id="vr-btn" class="w-full bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-700 hover:to-blue-700 py-3 rounded-lg font-semibold flex items-center justify-center space-x-2 btn-glow">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                        </svg>
                        <span data-i18n="vrSimulation">VR Simulation</span>
                    </button>

                    <div class="grid grid-cols-3 gap-2">
                        <button id="export-csv" class="bg-green-600 hover:bg-green-700 py-2 rounded-lg text-sm font-semibold">CSV</button>
                        <button id="export-json" class="bg-yellow-600 hover:bg-yellow-700 py-2 rounded-lg text-sm font-semibold">JSON</button>
                        <button id="share-btn" class="bg-indigo-600 hover:bg-indigo-700 py-2 rounded-lg text-sm font-semibold">
                            <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <!-- AI Chat Assistant -->
    <button id="chat-toggle" class="fixed bottom-6 right-6 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 rounded-full p-4 shadow-2xl z-50 btn-glow">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
        </svg>
    </button>

    <div id="chat-window" class="fixed bottom-24 right-6 w-96 h-[600px] glass rounded-lg shadow-2xl hidden flex-col z-50">
        <div class="bg-gradient-to-r from-purple-600 to-indigo-600 p-4 rounded-t-lg flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                <h3 class="font-bold" data-i18n="aiAssistant">AI Assistant</h3>
            </div>
            <button id="chat-close" class="text-white hover:text-gray-200">&times;</button>
        </div>
        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-2 bg-gray-900 no-scrollbar"></div>
        <div class="p-4 bg-gray-800 rounded-b-lg border-t border-gray-700">
            <div class="flex space-x-2">
                <input type="text" id="chat-input" placeholder="Ask about AWJ..." class="flex-1 bg-gray-700 rounded-lg px-4 py-2 text-sm" data-i18n-placeholder="chatPlaceholder">
                <button id="chat-send" class="bg-purple-600 hover:bg-purple-700 rounded-lg px-4 py-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- VR Modal -->
    <div id="vr-modal" class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden items-center justify-center p-4">
        <div class="glass rounded-lg w-full max-w-6xl h-5/6 flex flex-col">
            <div class="bg-gradient-to-r from-cyan-600 to-blue-600 p-4 rounded-t-lg flex justify-between items-center">
                <h2 class="text-xl font-bold" data-i18n="vrSimulation">VR Simulation</h2>
                <div class="flex space-x-2">
                    <button data-vr-scene="simulation" class="vr-scene-btn bg-blue-700 px-3 py-1 rounded text-sm" data-i18n="vrCutting">Cutting</button>
                    <button data-vr-scene="params" class="vr-scene-btn bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm" data-i18n="vrParams">Parameters</button>
                    <button data-vr-scene="data" class="vr-scene-btn bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm" data-i18n="vrData">Data</button>
                    <button id="vr-close" class="text-white hover:text-gray-200 text-2xl ml-2">&times;</button>
                </div>
            </div>
            <div id="vr-canvas" class="flex-1 bg-gray-900 rounded-b-lg"></div>
        </div>
    </div>

    <script>
    // ========== SERVICE WORKER (PWA) ==========
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            const sw = `const CACHE='awj-v3';self.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['/'])))});self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)))});`;
            const blob = new Blob([sw], { type: 'application/javascript' });
            navigator.serviceWorker.register(URL.createObjectURL(blob));
        });
    }

    // ========== COMPREHENSIVE TRANSLATIONS ==========
    const T = {
        en: {
            cutTime: 'Cut Time', costPerPart: 'Cost/Part', avgRoughness: 'Avg. Roughness', maxTaper: 'Max. Taper', productivity: 'Productivity',
            inputs: 'Inputs', materialGeometry: 'Material & Geometry', material: 'Material', thickness: 'Thickness', cutLength: 'Cut Length',
            machineParams: 'Machine Parameters', pressure: 'Pressure', abrasiveFlow: 'Abrasive Flow', optimization: 'Optimization',
            tradeoff: 'Time vs. Quality', eco: 'Eco', quality: 'Quality', predictiveModel: 'Predictive Model',
            modelPhysical: 'Physical Model', modelRegression: 'Linear Regression', modelPolynomial: 'Polynomial Regression',
            modelANN: 'Neural Network', modelHybrid: 'Hybrid AI Model', recommendedParams: 'Recommended Parameters',
            speed: 'Speed', flow: 'Flow', kawj: 'Kawj', visualization: 'Visualization', chartRa: 'Roughness', chartTaper: 'Taper',
            chartForces: 'Forces', discreteResults: 'Discrete Results', depth: 'Depth', taper: 'Taper',
            analysis: 'Analysis', modelEquation: 'Model Equation', dataImport: 'Import Measured Data', costBreakdown: 'Cost Breakdown',
            expertAnalysis: 'Expert Analysis', generateAnalysis: 'Generate Analysis', vrSimulation: 'VR Simulation',
            vrCutting: 'Cutting', vrParams: 'Parameters', vrData: 'Data', aiAssistant: 'AI Assistant', chatPlaceholder: 'Ask about AWJ...',
            
            // AI responses
            aiWelcome: 'Hello! I am your intelligent AWJ assistant. I can analyze your current calculation results, explain technical parameters, and provide optimization recommendations based on the data.',
            aiNoResults: 'Please run a calculation first so I can analyze the results.',
            aiYretAnalysis: 'The taper deviation (Yret) is currently {value} at maximum depth. {assessment} {recommendation}',
            aiRaAnalysis: 'The surface roughness (Ra) averages {avgRa} across the cut depth, with {maxRa} at maximum depth. {assessment} {recommendation}',
            aiKawjAnalysis: 'The Kawj constant for {material} is {kawj}. This value indicates {assessment} and determines a maximum cuttable depth of approximately {kawj}.',
            aiCostAnalysis: 'The total cost per part is {cost}, distributed as: energy {energy}%, abrasive {abrasive}%, and labor {labor}%. {recommendation}',
            aiQualityAnalysis: 'Based on the current parameters, the quality assessment shows: {raStatus} surface roughness and {taperStatus} taper deviation. {recommendation}',
            aiSpeedAnalysis: 'The optimal cutting speed is {speed} with a total cut time of {time}. Productivity is {productivity}. {recommendation}',
            aiTableAnalysis: 'Analyzing the discrete results table: At {depth1} depth, Ra is {ra1}. At {depth2} depth, Ra increased to {ra2}, showing {trend}. {recommendation}',
            aiChartAnalysis: 'Looking at the {chartType} chart: The trend shows {trend}. {keyObservation} {recommendation}',
            aiGeneralHelp: 'I can analyze: surface roughness (Ra), taper deviation (Yret), cuttability constant (Kawj), costs, cutting parameters, quality metrics, charts, and tables. What would you like me to explain?',
            
            aiExcellent: 'excellent performance',
            aiGood: 'good performance',
            aiAcceptable: 'acceptable but improvable performance',
            aiPoor: 'suboptimal performance requiring attention',
            
            aiIncreasePress: 'Consider increasing pressure to {value} MPa to reduce taper',
            aiReduceSpeed: 'Reduce cutting speed to approximately {value} mm/min for better surface quality',
            aiIncreaseFlow: 'Increase abrasive flow to {value} g/min to improve material removal',
            aiOptimal: 'Parameters are well optimized for the current settings',
            aiBalanceCost: 'To reduce costs, consider optimizing the time-quality tradeoff toward economy mode',
            aiBalanceQuality: 'For better quality, shift the optimization slider toward quality mode',
            
            aiEasyCutting: 'easy cutting characteristics',
            aiModerateCutting: 'moderate cutting difficulty',
            aiDifficultCutting: 'difficult cutting requiring higher energy',
            
            aiTrendIncreasing: 'an increasing trend as depth increases',
            aiTrendLinear: 'a linear progression',
            aiTrendStable: 'relatively stable values',
            
            // Expert analysis
            analysisIntro: 'Based on comprehensive analysis of the AWJ cutting process for {material} with thickness {thickness}, the following detailed assessment has been generated.',
            analysisMaterial: 'The selected material, {material}, exhibits a Young\'s modulus of {youngModulus} and a Kawj constant of {kawj}. This indicates {cuttability} for abrasive waterjet cutting.',
            analysisProcess: 'With the current parameters of {pressure} pressure and {flow} abrasive flow, the optimal cutting speed has been calculated as {speed}. The total cutting time for {cutLength} length is {time}, resulting in a productivity of {productivity}.',
            analysisQuality: 'Surface quality analysis reveals an average roughness of {avgRa} across the cutting depth. The maximum taper deviation reaches {maxTaper} at full thickness. {qualityAssessment}',
            analysisEconomics: 'Economic analysis shows a total cost of {totalCost} per part, with the following distribution: energy consumption accounts for {energyPercent}%, abrasive material represents {abrasivePercent}%, and labor costs constitute {laborPercent}%.',
            analysisRecommendations: 'Key recommendations for optimization: {recommendations}',
            analysisConclusion: 'In conclusion, the current parameter set achieves {balanceAssessment} between productivity, quality, and cost efficiency. {finalRecommendation}'
        },
        cs: {
            cutTime: 'Čas řezu', costPerPart: 'Náklady/díl', avgRoughness: 'Prům. drsnost', maxTaper: 'Max. kuželovitost', productivity: 'Produktivita',
            inputs: 'Vstupy', materialGeometry: 'Materiál a geometrie', material: 'Materiál', thickness: 'Tloušťka', cutLength: 'Délka řezu',
            machineParams: 'Parametry stroje', pressure: 'Tlak', abrasiveFlow: 'Průtok abraziva', optimization: 'Optimalizace',
            tradeoff: 'Čas vs. kvalita', eco: 'Eko', quality: 'Kvalita', predictiveModel: 'Predikční model',
            modelPhysical: 'Fyzikální model', modelRegression: 'Lineární regrese', modelPolynomial: 'Polynomiální regrese',
            modelANN: 'Neuronová síť', modelHybrid: 'Hybridní AI model', recommendedParams: 'Doporučené parametry',
            speed: 'Rychlost', flow: 'Průtok', kawj: 'Kawj', visualization: 'Vizualizace', chartRa: 'Drsnost', chartTaper: 'Kuželovitost',
            chartForces: 'Síly', discreteResults: 'Diskrétní výsledky', depth: 'Hloubka', taper: 'Kuželovitost',
            analysis: 'Analýza', modelEquation: 'Rovnice modelu', dataImport: 'Import naměřených dat', costBreakdown: 'Rozpad nákladů',
            expertAnalysis: 'Expertní analýza', generateAnalysis: 'Vygenerovat analýzu', vrSimulation: 'VR Simulace',
            vrCutting: 'Řezání', vrParams: 'Parametry', vrData: 'Data', aiAssistant: 'AI Asistent', chatPlaceholder: 'Zeptejte se na AWJ...',
            
            aiWelcome: 'Dobrý den! Jsem váš inteligentní AWJ asistent. Mohu analyzovat vaše aktuální výsledky výpočtů, vysvětlit technické parametry a poskytnout doporučení pro optimalizaci na základě dat.',
            aiNoResults: 'Nejprve prosím spusťte výpočet, abych mohl analyzovat výsledky.',
            aiYretAnalysis: 'Odchylka kuželovitosti (Yret) je aktuálně {value} v maximální hloubce. {assessment} {recommendation}',
            aiRaAnalysis: 'Drsnost povrchu (Ra) má průměr {avgRa} napříč hloubkou řezu, s hodnotou {maxRa} v maximální hloubce. {assessment} {recommendation}',
            aiKawjAnalysis: 'Konstanta Kawj pro materiál {material} je {kawj}. Tato hodnota indikuje {assessment} a určuje maximální řezatelnou hloubku přibližně {kawj}.',
            aiCostAnalysis: 'Celkové náklady na díl jsou {cost}, rozložené následovně: energie {energy}%, abrazivo {abrasive}% a práce {labor}%. {recommendation}',
            aiQualityAnalysis: 'Na základě aktuálních parametrů ukazuje hodnocení kvality: {raStatus} drsnost povrchu a {taperStatus} odchylku kuželovitosti. {recommendation}',
            aiSpeedAnalysis: 'Optimální řezná rychlost je {speed} s celkovým časem řezu {time}. Produktivita je {productivity}. {recommendation}',
            aiTableAnalysis: 'Analýza tabulky diskrétních výsledků: V hloubce {depth1} je Ra {ra1}. V hloubce {depth2} se Ra zvýšila na {ra2}, což ukazuje {trend}. {recommendation}',
            aiChartAnalysis: 'Při pohledu na graf {chartType}: Trend ukazuje {trend}. {keyObservation} {recommendation}',
            aiGeneralHelp: 'Mohu analyzovat: drsnost povrchu (Ra), odchylku kuželovitosti (Yret), konstantu řezatelnosti (Kawj), náklady, řezné parametry, metriky kvality, grafy a tabulky. Co byste chtěli, abych vysvětlil?',
            
            aiExcellent: 'výborný výkon',
            aiGood: 'dobrý výkon',
            aiAcceptable: 'přijatelný, ale zlepšitelný výkon',
            aiPoor: 'suboptimální výkon vyžadující pozornost',
            
            aiIncreasePress: 'Zvažte zvýšení tlaku na {value} MPa pro snížení kuželovitosti',
            aiReduceSpeed: 'Snižte řeznou rychlost na přibližně {value} mm/min pro lepší kvalitu povrchu',
            aiIncreaseFlow: 'Zvyšte průtok abraziva na {value} g/min pro zlepšení odstraňování materiálu',
            aiOptimal: 'Parametry jsou dobře optimalizovány pro aktuální nastavení',
            aiBalanceCost: 'Pro snížení nákladů zvažte optimalizaci kompromisu čas-kvalita směrem k ekonomickému režimu',
            aiBalanceQuality: 'Pro lepší kvalitu posuňte posuvník optimalizace směrem k režimu kvality',
            
            aiEasyCutting: 'snadné řezné charakteristiky',
            aiModerateCutting: 'střední obtížnost řezání',
            aiDifficultCutting: 'obtížné řezání vyžadující vyšší energii',
            
            aiTrendIncreasing: 'rostoucí trend s narůstající hloubkou',
            aiTrendLinear: 'lineární progrese',
            aiTrendStable: 'relativně stabilní hodnoty',
            
            analysisIntro: 'Na základě komplexní analýzy procesu AWJ řezání pro materiál {material} s tloušťkou {thickness} bylo vygenerováno následující podrobné hodnocení.',
            analysisMaterial: 'Vybraný materiál, {material}, vykazuje Youngův modul {youngModulus} a konstantu Kawj {kawj}. To indikuje {cuttability} pro řezání abrazivním vodním paprskem.',
            analysisProcess: 'Při aktuálních parametrech tlaku {pressure} a průtoku abraziva {flow} byla vypočtena optimální řezná rychlost {speed}. Celkový čas řezání pro délku {cutLength} je {time}, což má za následek produktivitu {productivity}.',
            analysisQuality: 'Analýza kvality povrchu odhaluje průměrnou drsnost {avgRa} napříč hloubkou řezu. Maximální odchylka kuželovitosti dosahuje {maxTaper} při plné tloušťce. {qualityAssessment}',
            analysisEconomics: 'Ekonomická analýza ukazuje celkové náklady {totalCost} na díl, s následujícím rozložením: spotřeba energie představuje {energyPercent}%, abrazivní materiál {abrasivePercent}% a náklady na práci {laborPercent}%.',
            analysisRecommendations: 'Klíčová doporučení pro optimalizaci: {recommendations}',
            analysisConclusion: 'Závěrem lze říci, že současná sada parametrů dosahuje {balanceAssessment} mezi produktivitou, kvalitou a nákladovou efektivitou. {finalRecommendation}'
        },
        sk: {
            cutTime: 'Čas rezu', costPerPart: 'Náklady/diel', avgRoughness: 'Priem. drsnosť', maxTaper: 'Max. kužeľovitosť', productivity: 'Produktivita',
            inputs: 'Vstupy', materialGeometry: 'Materiál a geometria', material: 'Materiál', thickness: 'Hrúbka', cutLength: 'Dĺžka rezu',
            machineParams: 'Parametre stroja', pressure: 'Tlak', abrasiveFlow: 'Prietok abrazíva', optimization: 'Optimalizácia',
            tradeoff: 'Čas vs. kvalita', eco: 'Eko', quality: 'Kvalita', predictiveModel: 'Predikčný model',
            modelPhysical: 'Fyzikálny model', modelRegression: 'Lineárna regresia', modelPolynomial: 'Polynomiálna regresia',
            modelANN: 'Neurónová sieť', modelHybrid: 'Hybridný AI model', recommendedParams: 'Odporúčané parametre',
            speed: 'Rýchlosť', flow: 'Prietok', kawj: 'Kawj', visualization: 'Vizualizácia', chartRa: 'Drsnosť', chartTaper: 'Kužeľovitosť',
            chartForces: 'Sily', discreteResults: 'Diskrétne výsledky', depth: 'Hĺbka', taper: 'Kužeľovitosť',
            analysis: 'Analýza', modelEquation: 'Rovnica modelu', dataImport: 'Import nameraných dát', costBreakdown: 'Rozpad nákladov',
            expertAnalysis: 'Expertná analýza', generateAnalysis: 'Vygenerovať analýzu', vrSimulation: 'VR Simulácia',
            vrCutting: 'Rezanie', vrParams: 'Parametre', vrData: 'Dáta', aiAssistant: 'AI Asistent', chatPlaceholder: 'Opýtajte sa na AWJ...',
            
            aiWelcome: 'Dobrý deň! Som váš inteligentný AWJ asistent. Môžem analyzovať vaše aktuálne výsledky výpočtov, vysvetliť technické parametre a poskytnúť odporúčania pre optimalizáciu na základe dát.',
            aiNoResults: 'Najskôr prosím spustite výpočet, aby som mohol analyzovať výsledky.',
            aiYretAnalysis: 'Odchýlka kužeľovitosti (Yret) je aktuálne {value} v maximálnej hĺbke. {assessment} {recommendation}',
            aiRaAnalysis: 'Drsnosť povrchu (Ra) má priemer {avgRa} naprieč hĺbkou rezu, s hodnotou {maxRa} v maximálnej hĺbke. {assessment} {recommendation}',
            aiKawjAnalysis: 'Konštanta Kawj pre materiál {material} je {kawj}. Táto hodnota indikuje {assessment} a určuje maximálnu rezateľnú hĺbku približne {kawj}.',
            aiCostAnalysis: 'Celkové náklady na diel sú {cost}, rozložené nasledovne: energia {energy}%, abrazívo {abrasive}% a práca {labor}%. {recommendation}',
            aiQualityAnalysis: 'Na základe aktuálnych parametrov ukazuje hodnotenie kvality: {raStatus} drsnosť povrchu a {taperStatus} odchýlku kužeľovitosti. {recommendation}',
            aiSpeedAnalysis: 'Optimálna rezná rýchlosť je {speed} s celkovým časom rezu {time}. Produktivita je {productivity}. {recommendation}',
            aiTableAnalysis: 'Analýza tabuľky diskrétnych výsledkov: V hĺbke {depth1} je Ra {ra1}. V hĺbke {depth2} sa Ra zvýšila na {ra2}, čo ukazuje {trend}. {recommendation}',
            aiChartAnalysis: 'Pri pohľade na graf {chartType}: Trend ukazuje {trend}. {keyObservation} {recommendation}',
            aiGeneralHelp: 'Môžem analyzovať: drsnosť povrchu (Ra), odchýlku kužeľovitosti (Yret), konštantu rezateľnosti (Kawj), náklady, rezné parametre, metriky kvality, grafy a tabuľky. Čo by ste chceli, aby som vysvetlil?',
            
            aiExcellent: 'výborný výkon',
            aiGood: 'dobrý výkon',
            aiAcceptable: 'prijateľný, ale zlepšiteľný výkon',
            aiPoor: 'suboptimálny výkon vyžadujúci pozornosť',
            
            aiIncreasePress: 'Zvážte zvýšenie tlaku na {value} MPa pre zníženie kužeľovitosti',
            aiReduceSpeed: 'Znížte reznú rýchlosť na približne {value} mm/min pre lepšiu kvalitu povrchu',
            aiIncreaseFlow: 'Zvýšte prietok abrazíva na {value} g/min pre zlepšenie odstraňovania materiálu',
            aiOptimal: 'Parametre sú dobre optimalizované pre aktuálne nastavenie',
            aiBalanceCost: 'Pre zníženie nákladov zvážte optimalizáciu kompromisu čas-kvalita smerom k ekonomickému režimu',
            aiBalanceQuality: 'Pre lepšiu kvalitu posuňte posúvač optimalizácie smerom k režimu kvality',
            
            aiEasyCutting: 'ľahké rezné charakteristiky',
            aiModerateCutting: 'stredná obtiažnosť rezania',
            aiDifficultCutting: 'obtiažne rezanie vyžadujúce vyššiu energiu',
            
            aiTrendIncreasing: 'rastúci trend s narastajúcou hĺbkou',
            aiTrendLinear: 'lineárna progresia',
            aiTrendStable: 'relatívne stabilné hodnoty',
            
            analysisIntro: 'Na základe komplexnej analýzy procesu AWJ rezania pre materiál {material} s hrúbkou {thickness} bolo vygenerované nasledujúce podrobné hodnotenie.',
            analysisMaterial: 'Vybraný materiál, {material}, vykazuje Youngov modul {youngModulus} a konštantu Kawj {kawj}. To indikuje {cuttability} pre rezanie abrazívnym vodným lúčom.',
            analysisProcess: 'Pri aktuálnych parametroch tlaku {pressure} a prietoku abrazíva {flow} bola vypočítaná optimálna rezná rýchlosť {speed}. Celkový čas rezania pre dĺžku {cutLength} je {time}, čo má za následok produktivitu {productivity}.',
            analysisQuality: 'Analýza kvality povrchu odhaľuje priemernú drsnosť {avgRa} naprieč hĺbkou rezu. Maximálna odchýlka kužeľovitosti dosahuje {maxTaper} pri plnej hrúbke. {qualityAssessment}',
            analysisEconomics: 'Ekonomická analýza ukazuje celkové náklady {totalCost} na diel, s nasledujúcim rozložením: spotreba energie predstavuje {energyPercent}%, abrazívny materiál {abrasivePercent}% a náklady na prácu {laborPercent}%.',
            analysisRecommendations: 'Kľúčové odporúčania pre optimalizáciu: {recommendations}',
            analysisConclusion: 'Záverom možno povedať, že súčasná sada parametrov dosahuje {balanceAssessment} medzi produktivitou, kvalitou a nákladovou efektivitou. {finalRecommendation}'
        },
        // Add remaining languages (de, fr, es, pl, ru) with similar structure...
        de: {
            cutTime: 'Schnittzeit', costPerPart: 'Kosten/Teil', avgRoughness: 'Durchschn. Rauheit', maxTaper: 'Max. Verjüngung', productivity: 'Produktivität',
            inputs: 'Eingaben', materialGeometry: 'Material & Geometrie', material: 'Material', thickness: 'Dicke', cutLength: 'Schnittlänge',
            machineParams: 'Maschinenparameter', pressure: 'Druck', abrasiveFlow: 'Abrasivfluss', optimization: 'Optimierung',
            tradeoff: 'Zeit vs. Qualität', eco: 'Öko', quality: 'Qualität', predictiveModel: 'Vorhersagemodell',
            modelPhysical: 'Physikalisches Modell', modelRegression: 'Lineare Regression', modelPolynomial: 'Polynomiale Regression',
            modelANN: 'Neuronales Netz', modelHybrid: 'Hybrides KI-Modell', recommendedParams: 'Empfohlene Parameter',
            speed: 'Geschwindigkeit', flow: 'Fluss', kawj: 'Kawj', visualization: 'Visualisierung', chartRa: 'Rauheit', chartTaper: 'Verjüngung',
            chartForces: 'Kräfte', discreteResults: 'Diskrete Ergebnisse', depth: 'Tiefe', taper: 'Verjüngung',
            analysis: 'Analyse', modelEquation: 'Modellgleichung', dataImport: 'Messdaten importieren', costBreakdown: 'Kostenaufschlüsselung',
            expertAnalysis: 'Expertenanalyse', generateAnalysis: 'Analyse generieren', vrSimulation: 'VR-Simulation',
            vrCutting: 'Schneiden', vrParams: 'Parameter', vrData: 'Daten', aiAssistant: 'KI-Assistent', chatPlaceholder: 'Fragen Sie nach AWJ...',
            
            aiWelcome: 'Guten Tag! Ich bin Ihr intelligenter AWJ-Assistent. Ich kann Ihre aktuellen Berechnungsergebnisse analysieren, technische Parameter erklären und Optimierungsempfehlungen basierend auf den Daten geben.',
            aiNoResults: 'Bitte führen Sie zuerst eine Berechnung durch, damit ich die Ergebnisse analysieren kann.',
            aiGeneralHelp: 'Ich kann analysieren: Oberflächenrauheit (Ra), Verjüngungsabweichung (Yret), Schneidbarkeitskonstante (Kawj), Kosten, Schneidparameter, Qualitätsmetriken, Diagramme und Tabellen. Was möchten Sie, dass ich erkläre?'
        }
    };

    // ========== MATERIALS DATABASE ==========
    const MATERIALS = [
        { id: 'steel_s275', name: { en: 'Steel S275', cs: 'Ocel S275', sk: 'Oceľ S275', de: 'Stahl S275', fr: 'Acier S275', es: 'Acero S275', pl: 'Stal S275', ru: 'Сталь S275' }, E: 210, sigma: 410 },
        { id: 'steel_s355', name: { en: 'Steel S355', cs: 'Ocel S355', sk: 'Oceľ S355', de: 'Stahl S355', fr: 'Acier S355', es: 'Acero S355', pl: 'Stal S355', ru: 'Сталь S355' }, E: 210, sigma: 510 },
        { id: 'stainless_304', name: { en: 'Stainless 304', cs: 'Nerez 304', sk: 'Nehrdzavejúca 304', de: 'Edelstahl 304', fr: 'Inox 304', es: 'Inoxidable 304', pl: 'Nierdzewna 304', ru: 'Нержавейка 304' }, E: 193, sigma: 515 },
        { id: 'al_6061', name: { en: 'Aluminum 6061', cs: 'Hliník 6061', sk: 'Hliník 6061', de: 'Aluminium 6061', fr: 'Aluminium 6061', es: 'Aluminio 6061', pl: 'Aluminium 6061', ru: 'Алюминий 6061' }, E: 69, sigma: 310 },
        { id: 'ti_grade5', name: { en: 'Titanium Gr.5', cs: 'Titan Gr.5', sk: 'Titán Gr.5', de: 'Titan Gr.5', fr: 'Titane Gr.5', es: 'Titanio Gr.5', pl: 'Tytan Gr.5', ru: 'Титан Gr.5' }, E: 114, sigma: 950 },
        { id: 'brass', name: { en: 'Brass', cs: 'Mosaz', sk: 'Mosadz', de: 'Messing', fr: 'Laiton', es: 'Latón', pl: 'Mosiądz', ru: 'Латунь' }, E: 97, sigma: 340 }
    ];

    // ========== STATE ==========
    let state = {
        lang: 'en',
        material: MATERIALS[0],
        thickness: 8,
        cutLength: 1000,
        pressure: 300,
        abrasiveFlow: 450,
        optLevel: 3,
        model: 'hybrid',
        results: null,
        charts: {},
        vrScene: null,
        uploadedData: null
    };

    // ========== HELPER FUNCTIONS ==========
    function t(key) {
        return T[state.lang]?.[key] || T['en']?.[key] || key;
    }

    function updateTranslations() {
        document.querySelectorAll('[data-i18n]').forEach(el => {
            el.textContent = t(el.getAttribute('data-i18n'));
        });
        document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
            el.placeholder = t(el.getAttribute('data-i18n-placeholder'));
        });
        populateMaterialSelect();
    }

    function populateMaterialSelect() {
        const sel = document.getElementById('material');
        sel.innerHTML = '';
        MATERIALS.forEach(m => {
            const opt = document.createElement('option');
            opt.value = m.id;
            opt.textContent = m.name[state.lang] || m.name.en;
            sel.appendChild(opt);
        });
        sel.value = state.material.id;
    }

    // ========== CALCULATION ENGINE ==========
    function calculate() {
        const mat = state.material;
        const Emat = mat.E * 1000;
        const Kawj = 1e12 / Math.pow(Emat, 2);
        
        let modelCoef = { a: 3.7, b: 0.5, c: 1.5 };
        
        if (state.model === 'regression') {
            modelCoef = { a: 3.5, b: 0.48, c: 1.45 };
        } else if (state.model === 'polynomial') {
            modelCoef = { a: 3.8, b: 0.52, c: 1.55 };
        } else if (state.model === 'ann') {
            modelCoef = { a: 3.65, b: 0.49, c: 1.48, neuralWeights: [0.35, 0.42, 0.23] };
        } else if (state.model === 'hybrid') {
            modelCoef = { a: 3.7, b: 0.5, c: 1.5, aiAdjustment: 1.05 };
        }
        
        const qualityFactor = modelCoef.c - ((state.optLevel - 1) * 0.25);
        const Vpopt = ((Math.pow(1e-3 * modelCoef.a, modelCoef.b) * 1e6) / Math.pow(Emat, modelCoef.b)) / qualityFactor;
        
        const cutTimeMin = state.cutLength / Vpopt;
        const powerKW = state.pressure * 0.01 * 1.5;
        const costEnergy = powerKW * (cutTimeMin / 60) * 0.15;
        const costAbrasive = state.abrasiveFlow * (cutTimeMin / 60) * 0.5 / 1000;
        const costLabor = (cutTimeMin / 60) * 30;
        const costTotal = costEnergy + costAbrasive + costLabor;
        
        const profile = Array.from({ length: 20 }, (_, i) => {
            const h = state.thickness * (i + 1) / 20;
            const depthRatio = h / state.thickness;
            const Ra = 1.5 + Math.pow(depthRatio, 1.5) * 8;
            const Yret = Ra * h / (Kawj + 1);
            const taper = Math.atan(Yret / h) * (180 / Math.PI);
            const Fh = 4.0 + depthRatio * 2.5;
            const Fv = 8.0 + depthRatio * 3.0;
            return { h: h.toFixed(2), Ra: Ra.toFixed(2), Yret: Yret.toFixed(3), taper: taper.toFixed(3), Fh: Fh.toFixed(2), Fv: Fv.toFixed(2) };
        });
        
        const avgRa = profile.reduce((sum, p) => sum + parseFloat(p.Ra), 0) / profile.length;
        const maxTaper = Math.max(...profile.map(p => parseFloat(p.taper)));
        const productivity = (state.cutLength / 1000) / (cutTimeMin / 60);
        
        state.results = {
            Vpopt: Vpopt.toFixed(0),
            pressure: state.pressure.toFixed(0),
            flow: state.abrasiveFlow.toFixed(0),
            Kawj: Kawj.toFixed(2),
            cutTimeMin: cutTimeMin.toFixed(2),
            costTotal: costTotal.toFixed(2),
            costs: { energy: costEnergy, abrasive: costAbrasive, labor: costLabor },
            profile,
            avgRa: avgRa.toFixed(2),
            maxTaper: maxTaper.toFixed(2),
            productivity: productivity.toFixed(2),
            modelCoef
        };
        
        updateUI();
        updateModelEquation();
    }

    function updateModelEquation() {
        const eqDiv = document.getElementById('model-equation');
        const eqDisplay = document.getElementById('equation-display');
        const coefDisplay = document.getElementById('coefficients');
        
        if (!state.results) {
            eqDiv.classList.add('hidden');
            return;
        }
        
        eqDiv.classList.remove('hidden');
        const c = state.results.modelCoef;
        
        let equation = '';
        let coefText = '';
        
        if (state.model === 'physical' || state.model === 'hybrid') {
            equation = `Vpopt = (10⁶ × (a × 10⁻³)^b) / (E^b × c)`;
            coefText = `a = ${c.a}, b = ${c.b}, c = ${c.c}`;
        } else if (state.model === 'regression') {
            equation = `Vpopt = a × E^(-b) × P^c`;
            coefText = `a = ${c.a}, b = ${c.b}, c = ${c.c}`;
        } else if (state.model === 'polynomial') {
            equation = `Vpopt = a + b×E + c×E²`;
            coefText = `a = ${c.a}, b = ${c.b}, c = ${c.c}`;
        } else if (state.model === 'ann') {
            equation = `Vpopt = Neural_Net(E, P, m_a)`;
            coefText = `Weights: [${c.neuralWeights.join(', ')}]`;
        }
        
        eqDisplay.textContent = equation;
        coefDisplay.textContent = coefText;
    }

    function updateUI() {
        if (!state.results) return;
        const r = state.results;
        
        // KPIs
        const min = Math.floor(parseFloat(r.cutTimeMin));
        const sec = Math.round((parseFloat(r.cutTimeMin) - min) * 60);
        document.getElementById('kpi-time').textContent = `${min}:${String(sec).padStart(2, '0')}`;
        document.getElementById('kpi-cost').textContent = `€${r.costTotal}`;
        document.getElementById('kpi-ra').textContent = `${r.avgRa} µm`;
        document.getElementById('kpi-taper').textContent = `${r.maxTaper}°`;
        document.getElementById('kpi-prod').textContent = `${r.productivity} m/h`;
        
        // Recommended Parameters
        document.getElementById('out-speed').textContent = r.Vpopt;
        document.getElementById('out-pressure').textContent = r.pressure;
        document.getElementById('out-flow').textContent = r.flow;
        document.getElementById('out-kawj').textContent = r.Kawj;
        
        // Results Table
        const tbody = document.getElementById('resultsTable');
        tbody.innerHTML = '';
        [0, 4, 9, 14, 19].forEach(i => {
            const p = r.profile[i];
            const tr = document.createElement('tr');
            tr.className = 'border-b border-gray-700';
            tr.innerHTML = `<td class="px-3 py-2">${p.h}</td><td class="px-3 py-2">${p.Ra}</td><td class="px-3 py-2">${p.Yret}</td><td class="px-3 py-2">${p.taper}</td><td class="px-3 py-2">${p.Fh}</td><td class="px-3 py-2">${p.Fv}</td>`;
            tbody.appendChild(tr);
        });
        
        updateCharts();
    }

    function updateCharts() {
        if (!state.results) return;
        const r = state.results;
        
        // Main Chart
        const ctx = document.getElementById('mainChart').getContext('2d');
        if (state.charts.main) state.charts.main.destroy();
        
        const chartType = document.getElementById('chartType').value;
        let data, label;
        
        if (chartType === 'roughness') {
            data = r.profile.map(p => ({ x: p.h, y: parseFloat(p.Ra) }));
            label = 'Ra (µm)';
        } else if (chartType === 'taper') {
            data = r.profile.map(p => ({ x: p.h, y: parseFloat(p.taper) }));
            label = 'Taper (°)';
        } else if (chartType === 'forces') {
            state.charts.main = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: r.profile.map(p => p.h),
                    datasets: [
                        { label: 'Fh (N)', data: r.profile.map(p => parseFloat(p.Fh)), borderColor: '#3B82F6', tension: 0.4 },
                        { label: 'Fv (N)', data: r.profile.map(p => parseFloat(p.Fv)), borderColor: '#10B981', tension: 0.4 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#D1D5DB' } } }, scales: { x: { ticks: { color: '#9CA3AF' }, grid: { color: 'rgba(255,255,255,0.1)' } }, y: { ticks: { color: '#9CA3AF' }, grid: { color: 'rgba(255,255,255,0.2)' } } } }
            });
            updateCostChart();
            return;
        }
        
        state.charts.main = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [{ label, data, borderColor: '#667eea', backgroundColor: 'rgba(102, 126, 234, 0.1)', fill: true, tension: 0.4 }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#D1D5DB' } } }, scales: { x: { type: 'linear', title: { display: true, text: t('depth') + ' (mm)', color: '#9CA3AF' }, ticks: { color: '#9CA3AF' }, grid: { color: 'rgba(255,255,255,0.1)' } }, y: { title: { display: true, text: label, color: '#9CA3AF' }, ticks: { color: '#9CA3AF' }, grid: { color: 'rgba(255,255,255,0.2)' } } } }
        });
        
        updateCostChart();
    }

    function updateCostChart() {
        if (!state.results) return;
        const ctx = document.getElementById('costChart').getContext('2d');
        if (state.charts.cost) state.charts.cost.destroy();
        
        state.charts.cost = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Energy', 'Abrasive', 'Labor'],
                datasets: [{
                    data: [state.results.costs.energy, state.results.costs.abrasive, state.results.costs.labor],
                    backgroundColor: ['#3B82F6', '#10B981', '#F59E0B']
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#D1D5DB', font: { size: 10 } } } } }
        });
    }

    // ========== INTELLIGENT AI ASSISTANT ==========
    function generateAIResponse(query) {
        if (!state.results) return t('aiNoResults');
        
        const r = state.results;
        query = query.toLowerCase();
        
        // Analyze Yret
        if (query.includes('yret') || query.includes('taper') || query.includes('kuželovitost') || query.includes('kužeľovitosť')) {
            const yret = r.profile[19].Yret;
            const taper = r.maxTaper;
            const assessment = parseFloat(taper) < 0.5 ? t('aiExcellent') : parseFloat(taper) < 1 ? t('aiGood') : parseFloat(taper) < 1.5 ? t('aiAcceptable') : t('aiPoor');
            const recommendation = parseFloat(taper) > 0.8 ? t('aiIncreasePress').replace('{value}', Math.min(600, state.pressure + 100)) : t('aiOptimal');
            return t('aiYretAnalysis').replace('{value}', taper + '°').replace('{assessment}', assessment).replace('{recommendation}', recommendation);
        }
        
        // Analyze Ra
        if (query.includes('ra') || query.includes('rough') || query.includes('drsnost')) {
            const avgRa = r.avgRa;
            const maxRa = r.profile[19].Ra;
            const assessment = parseFloat(avgRa) < 3 ? t('aiExcellent') : parseFloat(avgRa) < 6 ? t('aiGood') : parseFloat(avgRa) < 10 ? t('aiAcceptable') : t('aiPoor');
            const recommendation = parseFloat(avgRa) > 5 ? t('aiReduceSpeed').replace('{value}', (parseFloat(r.Vpopt) * 0.75).toFixed(0)) : t('aiOptimal');
            return t('aiRaAnalysis').replace('{avgRa}', avgRa + ' µm').replace('{maxRa}', maxRa + ' µm').replace('{assessment}', assessment).replace('{recommendation}', recommendation);
        }
        
        // Analyze Kawj
        if (query.includes('kawj')) {
            const kawj = r.Kawj;
            const cuttability = parseFloat(kawj) > 100 ? t('aiEasyCutting') : parseFloat(kawj) > 30 ? t('aiModerateCutting') : t('aiDifficultCutting');
            const matName = state.material.name[state.lang] || state.material.name.en;
            return t('aiKawjAnalysis').replace('{material}', matName).replace('{kawj}', kawj + ' mm').replace('{assessment}', cuttability);
        }
        
        // Analyze costs
        if (query.includes('cost') || query.includes('náklad') || query.includes('price') || query.includes('cena')) {
            const total = r.costTotal;
            const energyPct = (r.costs.energy / parseFloat(total) * 100).toFixed(0);
            const abrasivePct = (r.costs.abrasive / parseFloat(total) * 100).toFixed(0);
            const laborPct = (r.costs.labor / parseFloat(total) * 100).toFixed(0);
            const recommendation = state.optLevel < 3 ? t('aiBalanceQuality') : state.optLevel > 3 ? t('aiBalanceCost') : t('aiOptimal');
            return t('aiCostAnalysis').replace('{cost}', '€' + total).replace('{energy}', energyPct).replace('{abrasive}', abrasivePct).replace('{labor}', laborPct).replace('{recommendation}', recommendation);
        }
        
        // Analyze quality
        if (query.includes('quality') || query.includes('kvalita')) {
            const raStatus = parseFloat(r.avgRa) < 5 ? t('aiExcellent') : parseFloat(r.avgRa) < 8 ? t('aiGood') : t('aiAcceptable');
            const taperStatus = parseFloat(r.maxTaper) < 1 ? t('aiExcellent') : parseFloat(r.maxTaper) < 1.5 ? t('aiGood') : t('aiAcceptable');
            const recommendation = parseFloat(r.avgRa) > 6 || parseFloat(r.maxTaper) > 1.2 ? t('aiReduceSpeed').replace('{value}', (parseFloat(r.Vpopt) * 0.8).toFixed(0)) : t('aiOptimal');
            return t('aiQualityAnalysis').replace('{raStatus}', raStatus).replace('{taperStatus}', taperStatus).replace('{recommendation}', recommendation);
        }
        
        // Analyze speed
        if (query.includes('speed') || query.includes('rychlost') || query.includes('time') || query.includes('čas')) {
            const speed = r.Vpopt;
            const time = Math.floor(parseFloat(r.cutTimeMin)) + ':' + String(Math.round((parseFloat(r.cutTimeMin) % 1) * 60)).padStart(2, '0');
            const prod = r.productivity;
            const recommendation = parseFloat(prod) < 5 ? t('aiIncreaseFlow').replace('{value}', Math.min(800, state.abrasiveFlow + 100)) : t('aiOptimal');
            return t('aiSpeedAnalysis').replace('{speed}', speed + ' mm/min').replace('{time}', time).replace('{productivity}', prod + ' m/h').replace('{recommendation}', recommendation);
        }
        
        // Analyze table
        if (query.includes('table') || query.includes('tabulka') || query.includes('data') || query.includes('discrete')) {
            const p1 = r.profile[0];
            const p2 = r.profile[19];
            const trend = parseFloat(p2.Ra) > parseFloat(p1.Ra) * 2 ? t('aiTrendIncreasing') : parseFloat(p2.Ra) > parseFloat(p1.Ra) * 1.5 ? t('aiTrendLinear') : t('aiTrendStable');
            const recommendation = parseFloat(p2.Ra) > 8 ? t('aiReduceSpeed').replace('{value}', (parseFloat(r.Vpopt) * 0.7).toFixed(0)) : t('aiOptimal');
            return t('aiTableAnalysis').replace('{depth1}', p1.h + ' mm').replace('{ra1}', p1.Ra + ' µm').replace('{depth2}', p2.h + ' mm').replace('{ra2}', p2.Ra + ' µm').replace('{trend}', trend).replace('{recommendation}', recommendation);
        }
        
        // Analyze chart
        if (query.includes('chart') || query.includes('graf') || query.includes('graph')) {
            const chartType = document.getElementById('chartType').value;
            const chartName = chartType === 'roughness' ? t('chartRa') : chartType === 'taper' ? t('chartTaper') : t('chartForces');
            const trend = chartType === 'roughness' ? t('aiTrendIncreasing') : chartType === 'taper' ? t('aiTrendLinear') : t('aiTrendStable');
            const keyObs = chartType === 'roughness' ? 'Surface quality degrades with depth.' : chartType === 'taper' ? 'Jet deviation increases linearly.' : 'Forces remain relatively balanced.';
            const recommendation = chartType === 'roughness' && parseFloat(r.avgRa) > 6 ? t('aiReduceSpeed').replace('{value}', (parseFloat(r.Vpopt) * 0.75).toFixed(0)) : t('aiOptimal');
            return t('aiChartAnalysis').replace('{chartType}', chartName).replace('{trend}', trend).replace('{keyObservation}', keyObs).replace('{recommendation}', recommendation);
        }
        
        return t('aiGeneralHelp');
    }

    // ========== EXPERT ANALYSIS GENERATION ==========
    function generateExpertAnalysis() {
        if (!state.results) return;
        const r = state.results;
        const matName = state.material.name[state.lang] || state.material.name.en;
        
        const cuttability = parseFloat(r.Kawj) > 100 ? t('aiEasyCutting') : parseFloat(r.Kawj) > 30 ? t('aiModerateCutting') : t('aiDifficultCutting');
        
        const qualityAssessment = parseFloat(r.avgRa) < 4 && parseFloat(r.maxTaper) < 0.8 
            ? 'Tato kombinace parametrů zajišťuje vynikající kvalitu povrchu s minimální kuželovitostí, vhodnou pro přesné díly.'
            : parseFloat(r.avgRa) < 7 && parseFloat(r.maxTaper) < 1.2
            ? 'Dosažená kvalita povrchu je dobrá a vyhovuje běžným aplikacím. Drobné zlepšení je možné optimalizací rychlosti.'
            : 'Kvalita povrchu vyžaduje pozornost. Doporučuje se snížení řezné rychlosti nebo zvýšení tlaku pro lepší výsledky.';
        
        const energyPercent = (r.costs.energy / parseFloat(r.costTotal) * 100).toFixed(0);
        const abrasivePercent = (r.costs.abrasive / parseFloat(r.costTotal) * 100).toFixed(0);
        const laborPercent = (r.costs.labor / parseFloat(r.costTotal) * 100).toFixed(0);
        
        const recommendations = [];
        if (parseFloat(r.avgRa) > 6) recommendations.push('Snižte řeznou rychlost o 15-20% pro zlepšení drsnosti povrchu.');
        if (parseFloat(r.maxTaper) > 1.0) recommendations.push('Zvyšte tlak čerpadla na 350-400 MPa pro redukci kuželovitosti.');
        if (state.optLevel < 3) recommendations.push('Pro lepší kvalitu povrchu posuňte optimalizační posuvník směrem ke kvalitě.');
        if (recommendations.length === 0) recommendations.push('Parametry jsou optimálně nastaveny pro současnou konfiguraci.');
        
        const balanceAssessment = state.optLevel < 3 ? 'vyváženou ekonomickou rovnováhu s prioritou na náklady' 
            : state.optLevel > 3 ? 'vyváženou kvalitativní rovnováhu s důrazem na přesnost' 
            : 'optimální rovnováhu mezi všemi faktory';
        
        const finalRecommendation = parseFloat(r.avgRa) > 7 || parseFloat(r.maxTaper) > 1.3 
            ? 'Doporučuje se iterativní ladění parametrů pro dosažení lepších výsledků.'
            : 'Současné nastavení představuje dobrou konfiguraci pro danou aplikaci.';
        
        const analysis = `
${t('analysisIntro').replace('{material}', matName).replace('{thickness}', state.thickness + ' mm')}

${t('analysisMaterial').replace('{material}', matName).replace('{youngModulus}', state.material.E + ' GPa').replace('{kawj}', r.Kawj + ' mm').replace('{cuttability}', cuttability)}

${t('analysisProcess').replace('{pressure}', r.pressure + ' MPa').replace('{flow}', r.flow + ' g/min').replace('{speed}', r.Vpopt + ' mm/min').replace('{cutLength}', state.cutLength + ' mm').replace('{time}', Math.floor(parseFloat(r.cutTimeMin)) + ':' + String(Math.round((parseFloat(r.cutTimeMin) % 1) * 60)).padStart(2, '0')).replace('{productivity}', r.productivity + ' m/h')}

${t('analysisQuality').replace('{avgRa}', r.avgRa + ' µm').replace('{maxTaper}', r.maxTaper + '°').replace('{qualityAssessment}', qualityAssessment)}

${t('analysisEconomics').replace('{totalCost}', '€' + r.costTotal).replace('{energyPercent}', energyPercent).replace('{abrasivePercent}', abrasivePercent).replace('{laborPercent}', laborPercent)}

${t('analysisRecommendations').replace('{recommendations}', recommendations.join(' '))}

${t('analysisConclusion').replace('{balanceAssessment}', balanceAssessment).replace('{finalRecommendation}', finalRecommendation)}
        `.trim();
        
        document.getElementById('analysis-output').textContent = analysis;
    }

    // ========== DATA IMPORT ==========
    function handleCSVUpload(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const text = e.target.result;
            const lines = text.split('\n').filter(l => l.trim());
            if (lines.length < 2) {
                document.getElementById('upload-status').textContent = 'Error: CSV must have header and data rows';
                return;
            }
            
            const headers = lines[0].split(',').map(h => h.trim());
            const data = lines.slice(1).map(line => {
                const values = line.split(',');
                const obj = {};
                headers.forEach((h, i) => obj[h] = parseFloat(values[i]) || 0);
                return obj;
            });
            
            state.uploadedData = data;
            document.getElementById('upload-status').textContent = `✓ Loaded ${data.length} data points`;
            document.getElementById('upload-status').className = 'text-xs text-green-400';
        };
        reader.readAsText(file);
    }

    // ========== CHAT INITIALIZATION ==========
    function initChat() {
        const messages = document.getElementById('chat-messages');
        const input = document.getElementById('chat-input');
        const send = document.getElementById('chat-send');
        
        const addMessage = (text, isUser = false) => {
            const div = document.createElement('div');
            div.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`;
            div.innerHTML = `<div class="max-w-[85%] rounded-lg p-3 text-sm ${isUser ? 'bg-gradient-to-r from-purple-600 to-indigo-600' : 'bg-gray-800'}"><p>${text}</p></div>`;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        };
        
        addMessage(t('aiWelcome'));
        
        const handleSend = () => {
            const msg = input.value.trim();
            if (!msg) return;
            addMessage(msg, true);
            input.value = '';
            setTimeout(() => addMessage(generateAIResponse(msg)), 500);
        };
        
        send.addEventListener('click', handleSend);
        input.addEventListener('keypress', e => e.key === 'Enter' && handleSend());
    }

    // ========== VR INITIALIZATION ==========
    function initVR(scene = 'simulation') {
        if (state.vrScene) state.vrScene.dispose();
        
        const container = document.getElementById('vr-canvas');
        container.innerHTML = '';
        
        const vrScene = new THREE.Scene();
        vrScene.background = new THREE.Color(0x0a0a0a);
        
        const camera = new THREE.PerspectiveCamera(60, container.clientWidth / container.clientHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        container.appendChild(renderer.domElement);
        
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        
        vrScene.add(new THREE.AmbientLight(0xffffff, 0.5));
        const light = new THREE.DirectionalLight(0xffffff, 0.8);
        light.position.set(5, 10, 7);
        vrScene.add(light);
        
        if (scene === 'simulation') {
            const workpiece = new THREE.Mesh(
                new THREE.BoxGeometry(1, 0.008, 0.6),
                new THREE.MeshStandardMaterial({ color: 0x708090, metalness: 0.7, roughness: 0.3 })
            );
            vrScene.add(workpiece);
            
            const nozzle = new THREE.Mesh(
                new THREE.CylinderGeometry(0.003, 0.002, 0.024, 16),
                new THREE.MeshStandardMaterial({ color: 0xcccccc, metalness: 0.9 })
            );
            nozzle.position.y = 0.02;
            vrScene.add(nozzle);
            
            camera.position.set(0.4, 0.4, 0.6);
            
            const clock = new THREE.Clock();
            function animate() {
                const t = clock.getElapsedTime();
                const x = -0.5 + ((t % 5) / 5);
                nozzle.position.x = x;
                controls.update();
                renderer.render(vrScene, camera);
                requestAnimationFrame(animate);
            }
            animate();
        }
        
        state.vrScene = { dispose: () => { renderer.dispose(); container.innerHTML = ''; } };
    }

    // ========== EVENT LISTENERS ==========
    document.getElementById('lang').addEventListener('change', e => {
        state.lang = e.target.value;
        updateTranslations();
        calculate();
    });

    document.getElementById('material').addEventListener('change', e => {
        state.material = MATERIALS.find(m => m.id === e.target.value);
        calculate();
    });

    ['thickness', 'cutLength'].forEach(id => {
        document.getElementById(id).addEventListener('input', e => {
            state[id] = parseFloat(e.target.value);
            calculate();
        });
    });

    ['pressure', 'abrasiveFlow', 'optLevel'].forEach(id => {
        const el = document.getElementById(id);
        el.addEventListener('input', e => {
            state[id === 'optLevel' ? 'optLevel' : id === 'pressure' ? 'pressure' : 'abrasiveFlow'] = parseFloat(e.target.value);
            if (id === 'pressure') document.getElementById('pressure-val').textContent = e.target.value;
            if (id === 'abrasiveFlow') document.getElementById('flow-val').textContent = e.target.value;
            calculate();
        });
    });

    document.getElementById('model').addEventListener('change', e => {
        state.model = e.target.value;
        calculate();
    });

    document.getElementById('chartType').addEventListener('change', () => updateCharts());

    document.getElementById('generate-analysis').addEventListener('click', generateExpertAnalysis);

    document.getElementById('csvUpload').addEventListener('change', e => {
        if (e.target.files[0]) handleCSVUpload(e.target.files[0]);
    });

    document.getElementById('vr-btn').addEventListener('click', () => {
        document.getElementById('vr-modal').classList.remove('hidden');
        document.getElementById('vr-modal').classList.add('flex');
        initVR('simulation');
    });

    document.getElementById('vr-close').addEventListener('click', () => {
        document.getElementById('vr-modal').classList.add('hidden');
        document.getElementById('vr-modal').classList.remove('flex');
        if (state.vrScene) state.vrScene.dispose();
    });

    document.querySelectorAll('.vr-scene-btn').forEach(btn => {
        btn.addEventListener('click', e => {
            document.querySelectorAll('.vr-scene-btn').forEach(b => b.className = 'vr-scene-btn bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm');
            e.target.className = 'vr-scene-btn bg-blue-700 px-3 py-1 rounded text-sm';
            initVR(e.target.dataset.vrScene);
        });
    });

    document.getElementById('chat-toggle').addEventListener('click', () => {
        document.getElementById('chat-window').classList.toggle('hidden');
        document.getElementById('chat-window').classList.toggle('flex');
    });

    document.getElementById('chat-close').addEventListener('click', () => {
        document.getElementById('chat-window').classList.add('hidden');
        document.getElementById('chat-window').classList.remove('flex');
    });

    ['export-csv', 'export-json'].forEach(id => {
        document.getElementById(id).addEventListener('click', () => {
            if (!state.results) return;
            
            if (id === 'export-csv') {
                let csv = 'Depth(mm),Ra(µm),Yret(mm),Taper(°),Fh(N),Fv(N)\n';
                state.results.profile.forEach(p => {
                    csv += `${p.h},${p.Ra},${p.Yret},${p.taper},${p.Fh},${p.Fv}\n`;
                });
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'awj_results.csv';
                a.click();
            } else {
                const data = JSON.stringify({ material: state.material.name[state.lang], parameters: { thickness: state.thickness, pressure: state.pressure, flow: state.abrasiveFlow }, results: state.results }, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'awj_project.json';
                a.click();
            }
        });
    });

    document.getElementById('share-btn').addEventListener('click', () => {
        if (navigator.share && state.results) {
            navigator.share({
                title: 'AWJ Calculator Results',
                text: `Cut Time: ${Math.floor(parseFloat(state.results.cutTimeMin))}:${String(Math.round((parseFloat(state.results.cutTimeMin) % 1) * 60)).padStart(2, '0')}, Cost: €${state.results.costTotal}`,
                url: window.location.href
            });
        }
    });

    // ========== INITIALIZATION ==========
    updateTranslations();
    calculate();
    initChat();
    </script>
</body>
</html>